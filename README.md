# Auxo-Reporter

The Auxo reporter is used to create MerkleTrees for the Auxo protocol.
It fetches data from The Graph, Snapshot and Directly from the blockchain, then calculates the rewards for each user and generates a MerkleTree of claims that can be uploaded on chain.

## Structure

```sh
Makefile        # set of pre-defined scripts to get you started

# Python files
reporter/        # Python application to parse config data into rewards database
  models/        # Classes and class behaviours
  queries/       # on chain and subgraph queries
  rewards/       # Reward calculations
  test/          # Unit tests
  run.py         # Main script to run the reporter
  *.py           # other misc python files needed for the app
reports/         # Output files relating to claims, voting, proposals, rewards and the final tree
config/          # Config files for the reporter
pyproject.toml   # Python tooling setup
requirements.txt # Python dependencies

# Typescript files
merkleTree/     # Typescript MerkleTree generator with OpenZeppelin
package.json    # NodeJS dependencies and scripts
tsconfig.json   # Typescript config
```

## Installation

Make sure you have Python, Pip, NodeJS, Yarn installed. Python 3.10+ is recommended.

The [Makefile](./Makefile) contains a set of scripts to get you started. Provided you have `make` installed:

Setup the python venv and activate:

```sh
make venv
source venv/bin/activate
```

Install everything :

```sh
make setup
```

Check for type errors and format everything:

```sh
make lint
```

Run unit tests

```sh
make test
```

> An E2E test gets run and will write to the `reports` folder in the year 2099. Feel free to delete this.

## Running the Application

### Setting up the `.env`:

The [example env](.env.example) file requires you to grab a number of contract addresses, subgraph endpoints and API keys. This needs only doing once and a lot of these are pre-populated for you.

### Running each epoch

Provided the env is configured, everything else is built from a config file, you can find full details by reading the [example file](./config/example.jsonc).

Feel free to copy this file and modify it to your needs.

Create the database of claims and rewards:

```sh
# You will be promoted to provide the path to your config file.
make claims
```

If all goes well, you should have a new folder `reports/{year}-{month}/`, i.e. `reports/2022-11/`.

In it you will have the following files:

```sh
csv/                  # Report data in CSV format
json/                 # Report data in JSON format
claims.json           # Rewards by ethereum address, nil for inactive/slashed users
epoch-conf.json       # autogenerated config file based on your input config file
reporter-db.json      # Full breakdown of all generated data. Can be readable by TinyDB
```

You can then generate the merkle tree file with:

```sh
make tree
```

This will output a `merkle-tree.json` file in the reports folder for your passed epoch.

You will be asked whether to post to IPFS. If you want to do this, you will need to follow the instructions below before building the merkle tree.

## Posting to IPFS

You can use [Web3.storage](https://web3.storage/tokens/) to create an API Key.

Add it to a `.env` file by copying the `.env.example` and adding your key.

That's it! Just follow the instructions in the command prompt and you will automatically post to the IPFS and generate a link.
